<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì™¸ì£¼ìš©ì—­ ë°•ìŠ¤í”Œë¡¯ Â· ë¶„ë¥˜ë³„ & ì—…ì²´ë³„ ë‚˜ë€íˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --brand:#60a5fa; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif}
    header{padding:18px 24px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0f172a 0%, #0b1222 100%)}
    h1{margin:0 0 6px;font-size:18px}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:18px 24px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
    select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1222;color:var(--ink)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    #plot{height:70vh}
    .hint{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:11px;background:#0b2546;color:#b9dcff;border:1px solid #1f3b66}
    .def-table{width:100%;border-collapse:collapse;margin-top:8px;background:#0b1222;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .def-table th,.def-table td{padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px;text-align:left}
    .def-table thead th{background:#0d1526;color:var(--muted);font-weight:600;font-size:12px}
    .callout{margin-top:10px;font-size:13px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .btn{display:flex;align-items:center;justify-content:center;height:42px;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1222;color:#e5e7eb;cursor:pointer;transition:.2s}
    .btn:hover{background:#1a253b;border-color:#4b5563}
    .section-title{margin:0 0 8px;font-size:15px;font-weight:600}
  </style>
</head>
<body>
  <header>
    <h1>ì™¸ì£¼ìš©ì—­ ë°•ìŠ¤í”Œë¡¯</h1>
    <div class="hint">
      ì¡°ê±´(í–‰ ì´ë¦„ ìë™ë§¤í•‘): ëŒ€ë¶„ë¥˜='ë¶„ë¥˜' ì…€ Â· Xì¶•='ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­' ì…€ Â· Yì¶•='ì„œë¹„ìŠ¤ë‹¨ê°€'
      <span class="badge">ì„œë¹„ìŠ¤ë‹¨ê°€</span> Â· ë²”ìœ„: <span class="badge">477â€“1000í–‰(ë¹„ì–´ìˆìœ¼ë©´ ë¬´ì‹œ)</span>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="section-title">ì»¨íŠ¸ë¡¤</div>
      <label>ëŒ€ë¶„ë¥˜(ë¶„ë¥˜ Â· Pì—´) ì„ íƒ</label>
      <select id="category"></select>

      <label style="margin-top:14px;">ì—…ì²´(êµ¬ë§¤ì²˜ëª…) ì„ íƒ</label>
      <select id="vendor"></select>

      <label style="margin-top:14px;">ì˜µì…˜</label>
      <div class="row">
        <select id="orientation">
          <option value="v" selected>ìˆ˜ì§ ë°•ìŠ¤(ì„œë¹„ìŠ¤ë“±ê¸‰ = Xì¶•)</option>
          <option value="h">ìˆ˜í‰ ë°•ìŠ¤(ì„œë¹„ìŠ¤ë“±ê¸‰ = Yì¶•)</option>
        </select>
        <select id="outliers">
          <option value="none" selected>ì´ìƒì¹˜ ìˆ¨ê¹€</option>
          <option value="suspected">ì´ìƒì¹˜ í‘œì‹œ</option>
        </select>
      </div>

      <div class="hint" style="margin-top:10px;">
        â€» í—¤ë”ê°€ ìˆì„ ê²½ìš°, <span class="mono">ë¶„ë¥˜(P)</span> / <span class="mono">ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­(U)</span> / <span class="mono">ì„œë¹„ìŠ¤ë‹¨ê°€(Z)</span> / <span class="mono">êµ¬ë§¤ì²˜ëª…</span> ì„ ìë™ ë§¤í•‘í•©ë‹ˆë‹¤.
      </div>
      <button id="loadDefault" class="btn" style="margin-top:12px;">ê¸°ë³¸ íŒŒì¼(data.xlsx) ìë™ ë¡œë“œ</button>
    </section>

    <section class="card">
      <div class="section-title">ë¶„ë¥˜ë³„ vs ì—…ì²´ë³„ Â· í•œ í™”ë©´ ë¹„êµ</div>
      <div id="plot"></div>
    </section>
  </div>

  <div class="wrap" style="grid-template-columns:1fr; padding-top:0;">
    <section class="card">
      <h2 style="margin:0 0 10px;font-size:16px;">ğŸ“¦ ë°•ìŠ¤í”Œë¡¯(Box Plot) ì •ì˜</h2>
      <p class="callout">
        ë°•ìŠ¤í”Œë¡¯ì€ ë°ì´í„°ì˜ ë¶„í¬ë¥¼ <strong>ì‚¬ë¶„ìœ„ìˆ˜(Quartiles)</strong> ì¤‘ì‹¬ìœ¼ë¡œ ìš”ì•½í•´ ë³´ì—¬ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
        ì¤‘ì•™ê°’(ì œ2ì‚¬ë¶„ìœ„ìˆ˜, Q2), <strong>ì‚¬ë¶„ìœ„ë²”ìœ„(IQR = Q3 âˆ’ Q1)</strong>, ê·¸ë¦¬ê³  <strong>ìˆ˜ì—¼(whisker)</strong>ì„ í†µí•´
        ì¤‘ì‹¬Â·ì‚°í¬Â·ì´ìƒì¹˜(outlier) ì—¬ë¶€ë¥¼ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
    </section>
  </div>

  <script>
    // --- ê³ ì • Xì¶• ìˆœì„œ ---
    const GRADE_ORDER = ['ì´ˆê¸‰','ì¤‘ê¸‰','ê³ ê¸‰','íŠ¹ê¸‰','ì»¨ì„¤í„´íŠ¸'];

    // --- ì„¤ì • ìƒìˆ˜ (ê¸°ë³¸ê°’) ---
    const EXCEL_SHEET_NAME = "ì™¸ì£¼ìš©ì—­"; // ì‹œíŠ¸ëª…
    const ROW_START = 477; // í¬í•¨ (ì—‘ì…€ 1-based)
    const ROW_END   = 1000; // í¬í•¨ (ì—‘ì…€ 1-based)
    // ê¸°ë³¸(í´ë°±) ì¸ë±ìŠ¤: P(15), U(20), Z(25)
    let COL_P_IDX = 15;  // Pì—´ = 0-based 15 (ë¶„ë¥˜)
    let COL_U_IDX = 20;  // Uì—´ = 0-based 20 (ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­)
    let COL_Z_IDX = 25;  // Zì—´ = 0-based 25 (ì„œë¹„ìŠ¤ë‹¨ê°€)
    let COL_VENDOR_IDX = -1; // í—¤ë” ìë™ë§¤í•‘ ê¸°ëŒ€: êµ¬ë§¤ì²˜ëª…

    const els = {
      loadDefault: document.getElementById('loadDefault'),
      category: document.getElementById('category'),
      vendor: document.getElementById('vendor'),
      orientation: document.getElementById('orientation'),
      outliers: document.getElementById('outliers'),
      plot: document.getElementById('plot'),
    };

    let state = { headers: [], rows: [], categoryValues: [], vendorValues: [] };

    // ===== (ì„ íƒ) ìë™ ë¡œë“œ: ê°™ì€ í´ë”ì˜ data.xlsx ì‹œë„ =====
    async function loadWorkbookFromArrayBuffer(ab) {
      const wb = XLSX.read(ab, { type: 'array' });
      const sheetName = wb.Sheets[EXCEL_SHEET_NAME] ? EXCEL_SHEET_NAME : wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:null });
    }

    async function tryLoadDefault() {
      try {
        const res = await fetch('data.xlsx', { cache:'no-store' });
        if (!res.ok) throw new Error();
        const ab = await res.arrayBuffer();
        const rows = await loadWorkbookFromArrayBuffer(ab);
        ingestRows(rows);
      } catch {
        if (location.hostname.endsWith('github.io')) {
          const user = location.hostname.split('.')[0];
          const parts = location.pathname.split('/').filter(Boolean);
          const repo = parts[0] || '';
          const branch = 'main';
          const dir = parts.slice(1, -1).join('/');
          const url = `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${dir ? dir + '/' : ''}data.xlsx?ts=${Date.now()}`;
          try {
            const res2 = await fetch(url, { cache:'no-store' });
            if (!res2.ok) throw new Error();
            const ab2 = await res2.arrayBuffer();
            const rows2 = await loadWorkbookFromArrayBuffer(ab2);
            ingestRows(rows2);
            return;
          } catch {
            els.plot.innerHTML = '<div style="padding:12px;color:#9ca3af;">data.xlsx ìë™ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì €ì¥ì†Œ ê²½ë¡œë‚˜ íŒŒì¼ ìœ„ì¹˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
          }
        }
      }
    }

    // === ìœ í‹¸: í—¤ë”ëª… ì •ê·œí™” ===
    function normHeader(v){ return String(v ?? '').trim().replaceAll(/\s+/g,'').toLowerCase(); }

    function autoMapColumns(headerRow){
      if (!headerRow?.length) return; // í´ë°± ìœ ì§€
      const hnorm = headerRow.map(normHeader);
      // ë¶„ë¥˜
      const idxP = hnorm.indexOf('ë¶„ë¥˜'); if (idxP !== -1) COL_P_IDX = idxP;
      // ì„œë¹„ìŠ¤ë“±ê¸‰ë‚´ì—­
      const idxU = (()=>{ const c=['ì„œë¹„ìŠ¤ë“±ê¸‰ë‚´ì—­','ì„œë¹„ìŠ¤ë“±ê¸‰','ë“±ê¸‰','ì„œë¹„ìŠ¤ë“±ê¸‰(ë‚´ì—­)'].map(s=>s.replaceAll(/\s+/g,'').toLowerCase()); for(const x of c){const i=hnorm.indexOf(x); if(i!==-1) return i;} return -1; })();
      if (idxU !== -1) COL_U_IDX = idxU;
      // ì„œë¹„ìŠ¤ë‹¨ê°€
      const idxZ = hnorm.indexOf('ì„œë¹„ìŠ¤ë‹¨ê°€'); if (idxZ !== -1) COL_Z_IDX = idxZ;
      // êµ¬ë§¤ì²˜ëª… (ì—…ì²´ëª…)
      const idxVendor = (()=>{ const c=['êµ¬ë§¤ì²˜ëª…','êµ¬ë§¤ì²˜','ê³µê¸‰ì—…ì²´','ì—…ì²´ëª…','ê±°ë˜ì²˜ëª…','ê³µê¸‰ì²˜'].map(s=>s.replaceAll(/\s+/g,'').toLowerCase()); for(const x of c){const i=hnorm.indexOf(x); if(i!==-1) return i;} return -1; })();
      if (idxVendor !== -1) COL_VENDOR_IDX = idxVendor;
    }

    // í–‰ ë°ì´í„° ì£¼ì…
    function ingestRows(rows) {
      if (!rows?.length) { alert('ì‹œíŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }
      const first = rows[0] || [];
      const headerLike = first.some(v => typeof v === 'string');
      const headerRow = headerLike ? first : [];
      const data = headerLike ? rows.slice(1) : rows.slice();

      // í—¤ë” ìë™ ë§¤í•‘ ì‹œë„
      if (headerLike) autoMapColumns(headerRow);

      const startIdx = ROW_START - 1 - (headerLike ? 1 : 0);
      const endIdx   = ROW_END   - 1 - (headerLike ? 1 : 0);
      const slice = data.filter((_, i) => i >= startIdx && i <= endIdx);

      state.rows = slice;
      state.headers = headerRow.length ? headerRow : generateFallbackHeaders(rows[0]?.length || guessMaxCols(slice));

      // ë¶„ë¥˜ ë“œë¡­ë‹¤ìš´
      const pVals = slice.map(r => r[COL_P_IDX]).filter(v => v != null && String(v).trim() !== '');
      state.categoryValues = Array.from(new Set(pVals.map(v => String(v)))).sort((a,b)=>a.localeCompare(b,'ko'));
      populateCategorySelect();

      // ì—…ì²´ ë“œë¡­ë‹¤ìš´ (êµ¬ë§¤ì²˜ëª…)
      if (COL_VENDOR_IDX >= 0){
        const vVals = slice.map(r => r[COL_VENDOR_IDX]).filter(v => v != null && String(v).trim() !== '');
        state.vendorValues = Array.from(new Set(vVals.map(v => String(v)))).sort((a,b)=>a.localeCompare(b,'ko'));
      } else {
        state.vendorValues = [];
      }
      populateVendorSelect();

      // ì´ë²¤íŠ¸
      els.orientation.onchange = drawCombined;
      els.outliers.onchange = drawCombined;

      drawCombined();
    }

    function guessMaxCols(rows){ return Math.max(0, ...rows.map(r => Array.isArray(r) ? r.length : 0)); }
    function generateFallbackHeaders(n){ const a=[]; for(let i=0;i<n;i++) a.push(columnLabel(i)); return a; }
    function columnLabel(idx){ let s='',n=idx; while(n>=0){ s=String.fromCharCode((n%26)+65)+s; n=Math.floor(n/26)-1; } return s; }

    function populateCategorySelect(){
      els.category.innerHTML = '';
      const optAll = document.createElement('option'); optAll.value='__ALL__'; optAll.textContent=`ì „ì²´ (${state.categoryValues.length}ê°œ ë¶„ë¥˜)`; els.category.appendChild(optAll);
      state.categoryValues.forEach(v=>{ const o=document.createElement('option'); o.value=String(v); o.textContent=String(v); els.category.appendChild(o); });
      els.category.value='__ALL__';
      els.category.onchange = drawCombined;
    }

    function populateVendorSelect(){
      els.vendor.innerHTML = '';
      if (!state.vendorValues.length){
        const o=document.createElement('option'); o.value='__NOVENDOR__'; o.textContent='(êµ¬ë§¤ì²˜ëª… ì—´ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”)'; o.disabled=true; o.selected=true; els.vendor.appendChild(o);
        els.vendor.disabled = true; return;
      }
      els.vendor.disabled = false;
      const optAll = document.createElement('option'); optAll.value='__ALL__'; optAll.textContent=`ì „ì²´ (${state.vendorValues.length}ê°œ ì—…ì²´)`; els.vendor.appendChild(optAll);
      state.vendorValues.forEach(v=>{ const o=document.createElement('option'); o.value=String(v); o.textContent=String(v); els.vendor.appendChild(o); });
      els.vendor.value='__ALL__';
      els.vendor.onchange = drawCombined;
    }

    // === í•œ í™”ë©´: ë¶„ë¥˜ë³„ vs ì—…ì²´ë³„ ë‚˜ë€íˆ (ê° ë“±ê¸‰ë³„ 2ê°œ ë°•ìŠ¤) ===
    function drawCombined(){
      if (!state.rows.length){ Plotly.purge(els.plot); return; }
      const catSel = els.category.value;           // '__ALL__' ë˜ëŠ” íŠ¹ì • ë¶„ë¥˜
      const vendorSel = els.vendor.value;          // '__ALL__' ë˜ëŠ” íŠ¹ì • ì—…ì²´
      const orient = els.orientation.value;        // 'v' or 'h'
      const showOutliers = els.outliers.value !== 'none';

      // 1) ë¶„ë¥˜ í•„í„° ì§‘í•©
      const rowsCat = state.rows.filter(r=>{
        const p=r[COL_P_IDX], u=r[COL_U_IDX], y=r[COL_Z_IDX];
        if (u==null || String(u).trim()==='') return false;
        if (y==null || y==='' || !isFinite(+y)) return false;
        if (catSel==='__ALL__') return true;
        return String(p)===catSel;
      });

      // 2) ì—…ì²´ í•„í„° ì§‘í•©
      const rowsVendor = (COL_VENDOR_IDX<0) ? [] : state.rows.filter(r=>{
        const vendor=r[COL_VENDOR_IDX], u=r[COL_U_IDX], y=r[COL_Z_IDX];
        if (vendor==null || String(vendor).trim()==='') return false;
        if (u==null || String(u).trim()==='') return false;
        if (y==null || y==='' || !isFinite(+y)) return false;
        if (vendorSel==='__ALL__') return true;
        return String(vendor)===vendorSel;
      });

      // ë“±ê¸‰ë³„ ê·¸ë£¹í•‘
      const mapByGrade = (rows)=>{
        const m=new Map();
        for(const r of rows){ const g=String(r[COL_U_IDX]).trim(); const v=+r[COL_Z_IDX]; if(!m.has(g)) m.set(g,[]); m.get(g).push(v); }
        return m;
      };
      const byGradeCat = mapByGrade(rowsCat);
      const byGradeVendor = mapByGrade(rowsVendor);

      const traces=[];
      const metricName = state.headers[COL_Z_IDX] ?? `ì—´ ${columnLabel(COL_Z_IDX)}`;

      const nameCat = (catSel==='__ALL__') ? 'ë¶„ë¥˜: ì „ì²´' : `ë¶„ë¥˜: ${catSel}`;
      const nameVendor = (vendorSel==='__ALL__') ? 'ì—…ì²´: ì „ì²´' : `ì—…ì²´: ${vendorSel}`;

      // A. ë¶„ë¥˜ íŠ¸ë ˆì´ìŠ¤ (ëª¨ë“  ë“±ê¸‰ì„ í•˜ë‚˜ì˜ traceë¡œ)
      const xDataCat = [], yDataCat = [];
      for(const g of GRADE_ORDER){
        const arrA=(byGradeCat.get(g)||[]).filter(Number.isFinite);
        for(const val of arrA){ xDataCat.push(g); yDataCat.push(val); }
      }
      if(xDataCat.length){
        const tA = {type:'box', name:nameCat, legendgroup:'cat', offsetgroup:'cat', boxpoints: showOutliers?'suspectedoutliers':false, jitter:.3, pointpos:0};
        if(orient==='v'){ tA.x=xDataCat; tA.y=yDataCat; tA.hovertemplate='%{x} Â· '+nameCat+'<br>%{y:,.0f}ì›<extra></extra>'; }
        else { tA.x=yDataCat; tA.y=xDataCat; tA.orientation='h'; tA.hovertemplate='%{y} Â· '+nameCat+'<br>%{x:,.0f}ì›<extra></extra>'; }
        traces.push(tA);
      }

      // B. ì—…ì²´ íŠ¸ë ˆì´ìŠ¤ (ëª¨ë“  ë“±ê¸‰ì„ í•˜ë‚˜ì˜ traceë¡œ)
      const xDataVendor = [], yDataVendor = [];
      for(const g of GRADE_ORDER){
        const arrB=(byGradeVendor.get(g)||[]).filter(Number.isFinite);
        for(const val of arrB){ xDataVendor.push(g); yDataVendor.push(val); }
      }
      if(xDataVendor.length){
        const tB = {type:'box', name:nameVendor, legendgroup:'vendor', offsetgroup:'vendor', boxpoints: showOutliers?'suspectedoutliers':false, jitter:.3, pointpos:0};
        if(orient==='v'){ tB.x=xDataVendor; tB.y=yDataVendor; tB.hovertemplate='%{x} Â· '+nameVendor+'<br>%{y:,.0f}ì›<extra></extra>'; }
        else { tB.x=yDataVendor; tB.y=xDataVendor; tB.orientation='h'; tB.hovertemplate='%{y} Â· '+nameVendor+'<br>%{x:,.0f}ì›<extra></extra>'; }
        traces.push(tB);
      }

      const numericAxis = { tickformat:',', ticksuffix:'ì›', gridcolor:'#1f2937', zerolinecolor:'#1f2937', automargin:true, title:{text:metricName, standoff:16} };
      const catAxis = { gridcolor:'#1f2937', zerolinecolor:'#1f2937', automargin:true, categoryorder:'array', categoryarray:GRADE_ORDER, tickmode:'array', tickvals:GRADE_ORDER, ticktext:GRADE_ORDER };

      const layout={ paper_bgcolor:'#0f172a', plot_bgcolor:'#0f172a', font:{color:'#e5e7eb'}, margin:{t:48,r:24,b:72,l:84}, showlegend:true, boxmode:'group', title:`ë¶„ë¥˜ vs ì—…ì²´ ë™ì‹œ ë¹„êµ Â· Yì¶•: ${metricName} (Zì—´)` };
      if (els.orientation.value==='v'){ layout.xaxis={title:'ì„œë¹„ìŠ¤ë“±ê¸‰ (Uì—´)',...catAxis}; layout.yaxis=numericAxis; }
      else { layout.xaxis=numericAxis; layout.yaxis={title:'ì„œë¹„ìŠ¤ë“±ê¸‰ (Uì—´)',...catAxis}; }

      Plotly.react(els.plot, traces, layout, {responsive:true, displaylogo:false});
    }

    // ì´ˆê¸°í™”
    els.loadDefault.addEventListener('click', tryLoadDefault);
    tryLoadDefault();
  </script>
</body>
</html>
