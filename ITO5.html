<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ITO 발주서 PDF 출력</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.3.1/html-docx.js"></script>
<style>
:root{
  --bg:#0f172a;--panel:#1e293b;--ink:#e2e8f0;--muted:#94a3b8;
  --accent:#3b82f6;--border:#334155;--paper:#fff;--ink2:#1e293b;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Batang","바탕",serif;background:var(--bg);color:var(--ink);min-height:100vh}

header{background:var(--panel);border-bottom:1px solid var(--border);padding:20px;position:sticky;top:0;z-index:100}
.header-content{max-width:1400px;margin:0 auto;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
.btn{padding:10px 18px;border-radius:8px;border:none;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;font-family:sans-serif}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#2563eb}
.btn-success{background:#10b981;color:#fff}
.btn-success:hover{background:#059669}
.btn:disabled{opacity:.5;cursor:not-allowed}
.file-input{padding:8px 14px;border:1px solid var(--border);border-radius:8px;background:#0f172a;color:var(--ink);font-size:14px;font-family:sans-serif}
.select{padding:8px 14px;border:1px solid var(--border);border-radius:8px;background:#0f172a;color:var(--ink);font-size:14px;min-width:200px;font-family:sans-serif}
.po-dropdown{position:absolute;top:100%;left:0;max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:#0f172a;display:none;margin-top:4px;z-index:1000;width:100%;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.5)}
.po-dropdown-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);font-size:14px;color:var(--ink)}
.po-dropdown-item:hover{background:#1e293b}
.po-dropdown-item:last-child{border-bottom:none}
.po-dropdown.show{display:block}

main{max-width:1400px;margin:20px auto;padding:0 20px}
.controls{background:var(--panel);padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid var(--border)}
.control-row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.control-row:last-child{margin-bottom:0}
.label{font-size:14px;color:var(--muted);min-width:100px;font-family:sans-serif}
.hint{font-size:12px;color:var(--muted);margin-top:8px;font-family:sans-serif}

.paper-container{background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--border)}
.paper{width:210mm;min-height:297mm;background:var(--paper);color:var(--ink2);margin:0 auto 20px;padding:15mm 20mm;position:relative;box-shadow:0 4px 20px rgba(0,0,0,.3)}

.doc-header{text-align:center;margin-bottom:8mm;border-bottom:2px solid #000;padding-bottom:8mm}
.doc-title{font-size:32px;font-weight:800;letter-spacing:4px;margin-bottom:4px}
.doc-subtitle{font-size:14px;color:#666;letter-spacing:2px}

.po-info{display:flex;justify-content:space-between;margin-bottom:8mm;font-size:13px}
.po-info-item{display:flex;gap:8px}
.po-info-label{font-weight:600}

.parties-section{display:grid;grid-template-columns:1fr 1fr;gap:15mm;margin-bottom:8mm;font-size:12px}
.party-box{border:1px solid #000;min-height:120px}
.party-title{background:#f0f0f0;padding:6px 10px;font-weight:700;text-align:left;border-bottom:1px solid #000}
.party-content{padding:8px 10px}
.party-row{display:grid;grid-template-columns:70px 1fr;margin-bottom:4px}
.party-row:last-child{margin-bottom:0}
.party-label{font-weight:600}

.greeting{text-align:center;margin:8mm 0;font-size:13px;line-height:1.8}

.items-table{width:100%;border-collapse:collapse;margin-bottom:6mm;font-size:12px}
.items-table th,.items-table td{border:1px solid #000;padding:6px 8px;text-align:center}
.items-table th{background:#f0f0f0;font-weight:700}
.items-table .desc{text-align:left}
.items-table .amount{text-align:right}

.contract-info{margin-bottom:6mm;font-size:12px;line-height:1.8}
.contract-info div{margin-bottom:3px}

.terms-section{margin-bottom:6mm;font-size:11px;line-height:1.7}
.terms-title{font-weight:700;margin-bottom:4px}
.terms-content{padding-left:8px}
.term-item{margin-bottom:6px}

.footer-notice{text-align:center;font-size:11px;margin-bottom:8mm;border-top:1px solid #ddd;border-bottom:1px solid #ddd;padding:8px 0}

.summary-box{width:250px;margin-left:auto;border:1px solid #000;font-size:12px}
.summary-row{display:flex;border-bottom:1px solid #000}
.summary-row:last-child{border-bottom:none}
.summary-row.total{background:#f0f0f0;font-weight:700}
.summary-label{width:100px;padding:6px 10px;border-right:1px solid #000;font-weight:600}
.summary-value{flex:1;padding:6px 10px;text-align:right}

.company-stamp{text-align:center;margin-top:10mm;font-size:13px;font-weight:700}

.page-number{position:absolute;bottom:10mm;right:20mm;font-size:11px;color:#666}

/* Page 2 styles */
.page2-title{font-size:18px;font-weight:700;text-align:center;margin-bottom:8mm;padding-bottom:4mm;border-bottom:2px solid #000}
.agreement-content{font-size:11px;line-height:1.8}
.agreement-section{margin-bottom:8mm}
.agreement-header{background:#f0f0f0;padding:8px;margin-bottom:6px;border:1px solid #000}
.agreement-article{margin-bottom:6mm}
.article-title{font-weight:700;margin-bottom:4px}
.article-content{padding-left:12px}
.article-item{margin-bottom:3px}
.signature-section{display:grid;grid-template-columns:1fr 1fr;gap:20mm;margin-top:15mm}
.signature-box{border:1px solid #000;padding:15px;text-align:left}
.signature-title{font-weight:700;margin-bottom:10px;font-size:14px}
.signature-info{font-size:12px;line-height:2}
.send-status{text-align:center;margin-top:10mm;color:#e74c3c;font-weight:700;font-size:13px}

@media print{
  body{background:#fff}
  header,.controls{display:none}
  .paper-container{background:none;padding:0;border:none}
  .paper{box-shadow:none;margin:0;page-break-after:always}
}
</style>
</head>
<body>

<header>
  <div class="header-content">
    <strong style="font-size:18px">📄 ITO 발주서 생성기</strong>
    <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input">
    <button id="fillBtn" class="btn btn-primary" disabled>🔍 조회하기</button>
    <button id="pdfBtn" class="btn btn-success" disabled>💾 PDF 다운로드</button>
    <button id="wordBtn" class="btn btn-success" disabled>📄 Word 다운로드</button>
  </div>
</header>

<main>
  <div class="controls">
    <div class="control-row">
      <span class="label">발주번호 선택:</span>
      <div style="position:relative;flex:1">
        <input type="text" id="poSearch" class="select" placeholder="발주번호 검색..." disabled style="width:100%;max-width:400px">
        <div id="poDropdown" class="po-dropdown"></div>
      </div>
      <select id="poSelect" class="select" disabled style="display:none">
        <option value="">파일을 먼저 선택하세요</option>
      </select>
    </div>
    <div class="hint">※ ITO.xlsx 파일을 선택하면 '25년' 시트의 발주번호 목록이 자동으로 표시됩니다.</div>
  </div>

  <div class="paper-container">
    <!-- PAGE 1 -->
    <div class="paper" id="printArea1">
      
      <div class="doc-header">
        <div class="doc-title">발 주 서</div>
        <div class="doc-subtitle">Purchase Order</div>
      </div>

      <div class="po-info">
        <div class="po-info-item">
          <span class="po-info-label">발주번호 :</span>
          <span id="poNumber">-</span>
        </div>
        <div class="po-info-item">
          <span class="po-info-label">발주일자 :</span>
          <span id="poDate">-</span>
        </div>
        <div class="po-info-item" style="color:#e74c3c;font-weight:700">
          <span id="sendStatus">미발송</span>
        </div>
      </div>

      <div class="parties-section">
        <div class="party-box">
          <div class="party-title">공급처</div>
          <div class="party-content">
            <div class="party-row">
              <span class="party-label">상　　호 :</span>
              <span id="supplierName">코바아이티(주)</span>
            </div>
            <div class="party-row">
              <span class="party-label">대 표 자 :</span>
              <span id="supplierCEO">윤인덕</span>
            </div>
            <div class="party-row">
              <span class="party-label">주　　소 :</span>
              <span id="supplierAddr">서울시 종로구 새문안로 5가길 28</span>
            </div>
            <div class="party-row">
              <span class="party-label">담 당 자 :</span>
              <span id="supplierContact">박용진 부장</span>
            </div>
            <div class="party-row">
              <span class="party-label">전화번호 :</span>
              <span id="supplierPhone">02-6244-9733</span>
            </div>
          </div>
        </div>

        <div class="party-box">
          <div class="party-title">발주처</div>
          <div class="party-content">
            <div class="party-row">
              <span class="party-label">상　　호 :</span>
              <span id="buyerName">한솔피엔에스㈜</span>
            </div>
            <div class="party-row">
              <span class="party-label">대 표 자 :</span>
              <span id="buyerCEO">김형준</span>
            </div>
            <div class="party-row">
              <span class="party-label">주　　소 :</span>
              <span id="buyerAddr">서울시 강서구 양천로 570 NH서울타워 6층</span>
            </div>
            <div class="party-row">
              <span class="party-label">담 당 자 :</span>
              <span id="buyerContact">최승철</span>
            </div>
            <div class="party-row">
              <span class="party-label">이 메 일 :</span>
              <span id="buyerEmail">seungcheol.choi@hansol.com</span>
            </div>
          </div>
        </div>
      </div>

      <div class="greeting">
        귀사의 일익 번창을 기원하며, 아래와 같이 발주합니다.
      </div>

      <table class="items-table">
        <thead>
          <tr>
            <th style="width:40px">No</th>
            <th style="width:80px">PO No</th>
            <th>품명 및 규격</th>
            <th style="width:60px">수량</th>
            <th style="width:50px">단위</th>
            <th style="width:100px">단가</th>
            <th style="width:100px">금액</th>
            <th style="width:80px">비고</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td id="itemPoNo">-</td>
            <td class="desc" id="itemDesc">-</td>
            <td id="itemQty" class="amount">-</td>
            <td id="itemUnit">-</td>
            <td id="itemPrice" class="amount">-</td>
            <td id="itemAmount" class="amount">-</td>
            <td id="itemNote">-</td>
          </tr>
        </tbody>
      </table>

      <div class="contract-info">
        <div><strong>계약기간 :</strong> <span id="contractPeriod">-</span></div>
        <div><strong>용역(수행) 장소 :</strong> <span id="workLocation">구매자 지정장소</span></div>
        <div><strong>대급지급조건 :</strong> <span id="paymentTerms">일시납 청구_30일내 현금지급</span></div>
        <div><strong>지체상금율 :</strong> <span id="penaltyRate">해당사항 없음</span></div>
      </div>

      <div class="terms-section">
        <div class="terms-title">특기사항</div>
        <div class="terms-content">
          <div class="term-item">
            <strong>- 검수 시기 및 방법 :</strong> 공급처는 발주서에 명시된 목적물의 납품 및 수행 완료 시 사전 합의된 검수 방법, 장소, 일자에 따라 검수확인서를 작성하여 발주처의 수령자 또는 과업 지시자에게 검수 확인을 받아야 한다.<br>
            검수요청이 있은 날로부터 영업일 기준 10일 이내에 발주처의 검사결과 및 불합격 사유에 대한 서면 통지가 없는 경우 검사에 합격한 것으로 본다.
          </div>
          <div class="term-item">
            <strong>- 하도급대금 조정 :</strong> 수급사업자는 계약기간 중 물가변동이나 대금산정의 기초가 된 조건의 일부가 변경되는 등 정당한 사유가 있거나, 원사업자의 요구와 관계없이 작업기간 또는 작업물량의 증가 등으로 수급사업자의 과업이 변경되거나 증가하였다고 판단될 경우, 원사업자에게 하도급대금의 조정을 서면으로 요청할 수 있다.
          </div>
        </div>
      </div>

      <div class="footer-notice">
        ※ 귀사의 견적과 당사의 발주서 내용 일치 시 인장 날인 후 원본 또는 사본을 발주처에 회신 바랍니다.
      </div>

      <div class="summary-box">
        <div class="summary-row">
          <div class="summary-label">공급가액</div>
          <div class="summary-value" id="supplyAmount">0</div>
        </div>
        <div class="summary-row">
          <div class="summary-label">부가세액</div>
          <div class="summary-value" id="taxAmount">0</div>
        </div>
        <div class="summary-row total">
          <div class="summary-label">합계금액</div>
          <div class="summary-value" id="totalAmount">0</div>
        </div>
      </div>

      <div class="company-stamp">
        한솔피엔에스 주식회사
      </div>

      <div class="page-number">Page 1 of 2</div>
    </div>

    <!-- PAGE 2 -->
    <div class="paper" id="printArea2">
      <div class="page2-title">정보보호 협약서</div>

      <div class="agreement-header">
        한솔피엔에스㈜아이티서비스부문 (이하 "위탁자"이라 한다)와(과) <span id="supplierName2">코바아이티(주)</span> (이하 "수탁자"라 한다)은(는) 다음과 같이 정보보호 협약을 체결한다.
      </div>

      <div class="agreement-content">
        <div style="margin-bottom:8mm">
          <strong>▣ 고객사 및 수행내역 :</strong> <span id="projectDesc">제지(환경사업본부) AI Report 유지보수</span>
        </div>

        <div class="agreement-article">
          <div class="article-title">제1조 (계약의 목적)</div>
          <div class="article-content">
            본 협약은 위탁자와 수탁자가 업무 수행 중에 얻게 되는 상호 자신의 비밀정보 및 고객사의 비밀정보를 보호하기 위함을 그 목적으로 한다.
          </div>
        </div>

        <div class="agreement-article">
          <div class="article-title">제2조 (정보보호의 대상)</div>
          <div class="article-content">
            본 협약상의 정보란 위탁자·수탁자간의 업무진행 과정에서 일방 당사자 및 고객사가 상대방에게 제공하거나 취득하는 일체의 영업 혹은 기술상의 정보 및 개인정보(이하 "비밀정보"라 한다)를 말한다. 서면, 구두 혹은 기타 방법으로 제공되는 모든 노하우, 공정, 도면, 설계, 실험결과, 샘플, 스펙, 데이터, 공식, 방법, 프로그램, 보고서, 계획서, 가격표, 거래명세서, 선전상의 아이디어, 사업정보, 고객정보, 임직원 정보, 개인정보 등을 모두 포함한다.
          </div>
        </div>

        <div class="agreement-article">
          <div class="article-title">제3조 (정보의 사용 용도 제한)</div>
          <div class="article-content">
            본 협약의 당사자는 상대방 및 고객사로부터 제공받은 비밀정보를 업무목적 외에 사용할 수 없으며, 계약의 수행을 위하여 상대방 및 고객사에 관련된 비밀정보를 제3자에게 제공할 경우, 당해 제3자와 별도의 정보보호협약을 체결하여야 하며 사전에 상대방 및 고객사의 허가를 득해야 한다.
          </div>
        </div>

        <div class="agreement-article">
          <div class="article-title">제4조 (적용기간)</div>
          <div class="article-content">
            본 협약의 정보보호의무는 계약기간 및 계약이 종료된 이후 3년간 유효하다. 단, 그 성질상 계속하여 효력을 유지하여야 할 정보는 유효기간이 만료된 이후에도 유효하다.
          </div>
        </div>

        <div class="agreement-article">
          <div class="article-title">제5조 (관리·감독 사항)</div>
          <div class="article-content">
            수탁자는 위탁자 및 고객사로부터 제공받은 정보를 자사 조직 내 목적상 부합하는 직원들에 한하여 이용하도록 조치하여야 하며 직원 각자에게 비밀유지의무를 주지시켜야 한다. 또한 위탁자가 요구하는 경우 수탁자는 자사의 관계직원들에 대하여 당해 직원이 본 협약상의 정보보호의무를 이행하겠다는 내용의 각서를 징구하는 등 위탁자가 만족할 수 있는 적절한 조치를 취하여야 한다.
          </div>
        </div>

        <div class="agreement-article">
          <div class="article-title">제6조 (기술적·관리적 보호조치)</div>
          <div class="article-content">
            수탁자는 위탁자 및 고객사로부터 제공받은 비밀정보를 보호하기 위하여 아래 각호에 해당하는 기술적, 관리적, 물리적 보호조치를 수행하여야 한다.<br>
            <div style="padding-left:12px;margin-top:4px">
              가. 비밀정보의 안전한 취급을 위한 내부관리계획의 수립·시행의 보호조치<br>
              나. 비밀정보에 불법적인 접근을 차단하기 위한 접근통제규칙, 침입차단시스템의 설치·운영 등의 보호조치<br>
              다. 비밀정보에 대한 접속기록의 위조·변조 방지를 위한 보호조치<br>
              라. 비밀정보가 안전하게 저장·전송될 수 있도록 보호조치<br>
              마. 악성프로그램의 침투여부를 점검·치료할 수 있는 백신소프트웨어의 설치·운영<br>
              바. 주요 개인정보 및 패스워드 암호화 조치<br>
              사. 전산실에 대한 출입통제 조치<br>
              아. 비밀정보가 담긴 문서, 저장매체에 대한 시건장치 적용 등 보호조치<br>
              자. 개인정보를 취급하는 경우 [개인정보보호법] 제24조 제3항 및 제29조, 동법 시행령 제21조 및 제30조, [개인정보의 안전성 확보조치 기준]에 따른 개인정보의 안전성 확보에 필요한 관리적, 기술적 조치
            </div>
          </div>
        </div>

        <div class="agreement-article">
          <div class="article-title">제7조 (비밀유지의무 제외사유)</div>
          <div class="article-content">
            수탁자는 계약내용에 관한 비밀은 물론 본 협약에 대해서도 위탁자 및 고객사의 동의 없이 누설하지 못한다. 다만, 다음에 해당하는 정보임이 객관적인 증거를 통하여 입증되는 경우는 비밀유지의무가 없다.<br>
            <div style="padding-left:12px;margin-top:4px">
              가. 위탁자 및 고객사의 비밀정보 제공 이전부터 수탁자가 보유하고 있던 정보.<br>
              나. 수탁자의 고의 또는 과실에 의하지 않고 공지의 사실로 된 정보.<br>
              다. 수탁자가 적법하게 제3자로부터 제공받은 정보.<br>
              라. 수탁자가 비밀정보와 관계없이 독자적으로 개발한 정보.<br>
              마. 위탁자 및 고객사가 공개를 허락한 정보.<br>
              바. 관련법규나 정부당국에 의하여 공개가 요구된 정보. 이 경우 사전에 반드시 위탁자에게 그 사실을 서면으로 통지하고, 위탁자로 하여금 적절한 보호 및 대응조치를 할 수 있도록 하여야 한다.
            </div>
          </div>
        </div>

        <div class="agreement-article">
          <div class="article-title">제8조 (침해사고 발생시 책임 및 손해배상)</div>
          <div class="article-content">
            당사자 일방이 본 협약을 위반하는 경우 귀책사유가 있는 당사자는 이로 인해 상대방에게 발생하는 손해에 대해서 전액 배상한다.
          </div>
        </div>

        <div class="agreement-article">
          <div class="article-title">제9조 (비밀정보 반환 또는 파기)</div>
          <div class="article-content">
            본 업무의 이행이 완료되거나 본 업무에 관한 계약이 해제 또는 해지된 경우 또는 위탁자나 수탁자 또는 고객사가 상대방에게 제공한 자신의 비밀정보의 반환을 요구할 경우, 상대방은 비밀정보를 상대방에게 반환하거나 파기하여야 한다. 단, 파기한 경우에는 그 증명을 서면으로 제출하여야 한다.<br>
            <div style="padding-left:12px;margin-top:4px">
              <strong>가. 파기방법</strong><br>
              1) 전자적 파일형태로 저장된 개인정보는 기록을 재생할 수 없는 기술적 방법을 사용하여 삭제하거나 물리적 파기<br>
              2) 종이에 출력된 개인정보는 분쇄기로 분쇄하거나 소각에 준하는 방법으로 완전 파기
            </div>
          </div>
        </div>
      </div>

      <div class="send-status">미발송</div>

      <div class="signature-section">
        <div class="signature-box">
          <div class="signature-title">위탁자</div>
          <div class="signature-info">
            <div id="buyerNameSig">한솔피엔에스㈜</div>
            <div id="buyerAddrSig">서울시 강서구 양천로 570 NH서울타워 6층</div>
            <div id="buyerCEOSig">김형준</div>
          </div>
        </div>
        <div class="signature-box">
          <div class="signature-title">수탁자</div>
          <div class="signature-info">
            <div id="supplierNameSig">코바아이티(주)</div>
            <div id="supplierAddrSig">서울시 종로구 새문안로5가길 28</div>
            <div id="supplierCEOSig">윤인덕</div>
          </div>
        </div>
      </div>

      <div class="page-number">Page 2 of 2</div>
    </div>
  </div>
</main>

<script>
let workbook = null;
let sheetData = null;
let allPONumbers = [];

const fileInput = document.getElementById('fileInput');
const poSearch = document.getElementById('poSearch');
const poSelect = document.getElementById('poSelect');
const poDropdown = document.getElementById('poDropdown');
const fillBtn = document.getElementById('fillBtn');
const pdfBtn = document.getElementById('pdfBtn');
const wordBtn = document.getElementById('wordBtn');

// 기본 파일 로드
window.addEventListener('load', loadDefaultFile);

fileInput.addEventListener('change', handleFile);
poSearch.addEventListener('input', filterPONumbers);
poSearch.addEventListener('focus', () => {
  if (allPONumbers.length > 0) poDropdown.classList.add('show');
});
document.addEventListener('click', (e) => {
  if (!poSearch.contains(e.target) && !poDropdown.contains(e.target)) {
    poDropdown.classList.remove('show');
  }
});
fillBtn.addEventListener('click', fillData);
pdfBtn.addEventListener('click', generatePDF);
wordBtn.addEventListener('click', generateWord);

async function loadDefaultFile() {
  try {
    const response = await fetch('https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/ITO.xlsx');
    const arrayBuffer = await response.arrayBuffer();
    const data = new Uint8Array(arrayBuffer);
    workbook = XLSX.read(data, {type: 'array'});
    processWorkbook();
  } catch (err) {
    console.log('기본 파일 로드 실패, 수동 업로드를 이용하세요:', err);
  }
}

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      workbook = XLSX.read(e.target.result, {type: 'binary'});
      processWorkbook();
    } catch (err) {
      alert('파일 읽기 오류: ' + err.message);
    }
  };
  reader.readAsBinaryString(file);
}

function processWorkbook() {
  let targetSheet = workbook.Sheets['25년'] || workbook.Sheets[workbook.SheetNames[0]];
  sheetData = XLSX.utils.sheet_to_json(targetSheet, {header: 1, defval: ''});
  
  if (sheetData.length === 0) {
    alert('시트에 데이터가 없습니다.');
    return;
  }
  
  const headers = sheetData[0];
  const poColIdx = headers.findIndex(h => h === '발주번호');
  
  if (poColIdx === -1) {
    alert('"발주번호" 열을 찾을 수 없습니다.');
    return;
  }
  
  allPONumbers = [];
  for (let i = 1; i < sheetData.length; i++) {
    const poNum = sheetData[i][poColIdx];
    if (poNum) allPONumbers.push(poNum);
  }
  
  poSearch.disabled = false;
  fillBtn.disabled = false;
  pdfBtn.disabled = false;
  wordBtn.disabled = false;
  poSearch.placeholder = '발주번호를 입력하세요...';
  
  displayPONumbers(allPONumbers);
}

function filterPONumbers() {
  const searchTerm = poSearch.value.toLowerCase();
  const filtered = allPONumbers.filter(po => 
    String(po).toLowerCase().includes(searchTerm)
  );
  displayPONumbers(filtered);
  poDropdown.classList.add('show');
}

function displayPONumbers(numbers) {
  poDropdown.innerHTML = '';
  if (numbers.length === 0) {
    poDropdown.innerHTML = '<div class="po-dropdown-item">검색 결과가 없습니다</div>';
    return;
  }
  
  numbers.forEach(po => {
    const item = document.createElement('div');
    item.className = 'po-dropdown-item';
    item.textContent = po;
    item.addEventListener('click', () => {
      poSearch.value = po;
      poDropdown.classList.remove('show');
    });
    poDropdown.appendChild(item);
  });
}

function fillData() {
  const selectedPO = poSearch.value;
  if (!selectedPO || !sheetData) {
    alert('발주번호를 선택하세요.');
    return;
  }
  
  const headers = sheetData[0];
  const getColIdx = (name) => headers.findIndex(h => h === name);
  
  const poColIdx = getColIdx('발주번호');
  const rowIdx = sheetData.findIndex((row, idx) => idx > 0 && row[poColIdx] === selectedPO);
  
  if (rowIdx === -1) {
    alert('해당 발주번호를 찾을 수 없습니다.');
    return;
  }
  
  const row = sheetData[rowIdx];
  const getValue = (colName, defaultVal = '-') => {
    const idx = getColIdx(colName);
    return idx !== -1 && row[idx] ? row[idx] : defaultVal;
  };
  
  // 발주 기본 정보
  document.getElementById('poNumber').textContent = selectedPO;
  document.getElementById('poDate').textContent = formatDate(getValue('발주일'));
  
  // 품목 정보
  document.getElementById('itemPoNo').textContent = selectedPO;
  document.getElementById('itemDesc').textContent = getValue('내용', '제지(환경사업본부) AI Report 유지보수');
  
  const qty = parseFloat(getValue('수량', 12)) || 12;
  const unit = getValue('단위', '개월');
  const price = parseFloat(getValue('단가', 10920000)) || 10920000;
  const amount = parseFloat(getValue('발주금액', qty * price)) || (qty * price);
  
  document.getElementById('itemQty').textContent = formatNumber(qty);
  document.getElementById('itemUnit').textContent = unit;
  document.getElementById('itemPrice').textContent = formatNumber(price);
  document.getElementById('itemAmount').textContent = formatNumber(amount);
  document.getElementById('itemNote').textContent = getValue('비고', '');
  
  // 금액 계산
  const supplyAmt = Math.round(amount / 12);
  const taxAmt = Math.round(supplyAmt * 0.1);
  const totalAmt = supplyAmt + taxAmt;
  
  document.getElementById('supplyAmount').textContent = formatNumber(supplyAmt);
  document.getElementById('taxAmount').textContent = formatNumber(taxAmt);
  document.getElementById('totalAmount').textContent = formatNumber(totalAmt);
  
  // 계약 기간
  const fromDate = getValue('FROM');
  const toDate = getValue('TO');
  if (fromDate && toDate && fromDate !== '-' && toDate !== '-') {
    document.getElementById('contractPeriod').textContent = 
      formatDate(fromDate) + ' ~ ' + formatDate(toDate);
  }
  
  // 공급처 정보
  const supplierName = getValue('공급처', '코바아이티(주)');
  document.getElementById('supplierName').textContent = supplierName;
  document.getElementById('supplierName2').textContent = supplierName;
  document.getElementById('supplierNameSig').textContent = supplierName;
  
  // 프로젝트 설명
  document.getElementById('projectDesc').textContent = getValue('내용', '제지(환경사업본부) AI Report 유지보수');
  
  document.getElementById('workLocation').textContent = getValue('용역장소', '구매자 지정장소');
  document.getElementById('paymentTerms').textContent = getValue('지급조건', '일시납 청구_30일내 현금지급');
}

function parseExcelDate(val) {
  if (typeof val === 'number') {
    return new Date((val - 25569) * 86400 * 1000);
  }
  if (typeof val === 'string' && val.includes('-')) {
    return new Date(val);
  }
  return null;
}

function formatDate(val) {
  if (!val || val === '-') return '-';
  const d = parseExcelDate(val);
  if (!d) return val;
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function formatNumber(num) {
  if (isNaN(num)) return '-';
  return new Intl.NumberFormat('ko-KR').format(num);
}

function generatePDF() {
  const page1 = document.getElementById('printArea1');
  const page2 = document.getElementById('printArea2');
  
  const opt = {
    margin: 0,
    filename: `발주서_${document.getElementById('poNumber').textContent || 'ITO'}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  
  html2pdf().set(opt).from(page1).toPdf().get('pdf').then(function(pdf) {
    pdf.addPage();
    return html2pdf().set(opt).from(page2).toPdf().get('pdf');
  }).then(function(pdf) {
    pdf.save(opt.filename);
  });
}

function generateWord() {
  const page1 = document.getElementById('printArea1').outerHTML;
  const page2 = document.getElementById('printArea2').outerHTML;
  
  const htmlContent = `
    <!DOCTYPE html>
    <html><head><meta charset="utf-8"></head><body>
    ${page1}
    <div style="page-break-before: always;"></div>
    ${page2}
    </body></html>
  `;
  
  const converted = htmlDocx.asBlob(htmlContent);
  const link = document.createElement('a');
  link.href = URL.createObjectURL(converted);
  link.download = `발주서_${document.getElementById('poNumber').textContent || 'ITO'}.docx`;
  link.click();
}
</script>