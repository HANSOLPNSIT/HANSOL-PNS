<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>업무협조요청 - 견적</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Excel 내보내기용 SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- 캡처용 html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- PDF 생성용 jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto,
        "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: #ffffff;
      color: #111827;
    }

    header {
      background: #e5e7eb;  /* gray */
      border-bottom: 1px solid #d1d5db;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    button {
      border: 1px solid #d1d5db;
      background: #f9fafb;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    button:hover {
      background: #e5e7eb;
    }

    main {
      padding: 16px 20px 32px;
    }

    /* 상하 레이아웃: 위에 <입력>, 아래에 업무협조요청 - 견적 */
    .layout {
      display: flex;
      flex-direction: column;
      gap: 18px;
      max-width: 1200px;
      margin: 0 auto;
    }

    #input-panel,
    #right-panel {
      width: 100%;
    }

    .panel {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #ffffff;
      padding: 16px 18px 18px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
    }

    .panel-title {
      margin: 0 0 12px;
      font-size: 15px;
      font-weight: 600;
      color: #111827;
    }

    /* 오른쪽 상단 제목 영역 */
    #right-panel .panel-title {
      text-align: center;
      font-size: 15px;      /* 요청 1 */
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 24px;  /* 제목과 세부내용 사이 여백 */
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-size: 12px;
      font-weight: 500;
      color: #374151;
      display: block;
      margin-bottom: 3px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      padding: 7px 8px;
      font-size: 13px;
    }

    textarea {
      resize: vertical;
      min-height: 50px;
      max-height: 160px;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .form-actions button.main {
      background: #111827;
      color: #ffffff;
      border-color: #111827;
    }

    .form-actions button.main:hover {
      background: #1f2937;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* 세부내용 영역 */
    .table-section h3 {
      margin-top: 24px;   /* 제목과 세부내용 글자 사이 여백 (위) */
      margin-bottom: 16px;/* 세부내용 글자 아래 여백 */
      font-size: 13px;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 8px 6px;   /* 칸 세로 폭 넓게 */
      vertical-align: top;
      word-break: break-all;
    }

    /* 헤더: 가운데 정렬 (요청 2) */
    th {
      font-weight: 600;
      color: #374151;
      text-align: center;
    }

    /* 데이터는 기본 왼쪽 정렬, 순번 열만 가운데 (요청 3) */
    td {
      text-align: left;
    }

    td:first-child {
      text-align: center;
      width: 40px;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .empty-state {
      font-size: 12px;
      color: #9ca3af;
      padding: 12px 4px 4px;
    }

    .preview-row {
      background: #fff7ed !important; /* 미리보기 행 강조 */
    }

    /* 템플릿용 빈 행: 칸이 넓게 보이도록 */
    .template-row td {
      height: 80px;
    }

    /* 예시화면 모달 */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .overlay.active {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: 10px;
      max-width: 980px;
      width: 95%;
      max-height: 90vh;
      padding: 16px 20px 18px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.25);
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      padding: 0 4px;
    }

    .modal-note {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>업무협조요청 - 견적</h1>
    <div class="header-actions">
      <button type="button" id="btnPdf">PDF다운</button>
      <button type="button" id="btnExample">예시화면</button>
      <button type="button" id="btnExcel">EXCEL다운</button>
      <button type="button" id="btnCapture">입력창캡쳐</button>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- 위: <입력> -->
      <section class="panel" id="input-panel">
        <h2 class="panel-title">&lt;입력&gt;</h2>
        <form id="inputForm">
          <div class="field-row">
            <div>
              <label for="project">프로젝트</label>
              <input type="text" id="project" autocomplete="off" />
            </div>
            <div>
              <label for="field">분야</label>
              <input type="text" id="field" autocomplete="off" />
            </div>
          </div>

          <div class="field-row">
            <div>
              <label for="people">인원</label>
              <input type="text" id="people" autocomplete="off" placeholder="예: 1명, 2명" />
            </div>
            <div>
              <label for="onsite">상주여부(지역)</label>
              <input type="text" id="onsite" autocomplete="off" placeholder="예: 상주(판교), 비상주(재택)" />
            </div>
          </div>

          <div>
            <label for="workSkill">업무, 필요기술</label>
            <!-- 기본값: 과업 / 업무상세 / 필요기술 구조 -->
            <textarea id="workSkill">과업 :
업무상세 :
필요기술 :</textarea>
          </div>

          <div>
            <label for="env">개발 환경</label>
            <textarea id="env" placeholder="개발 언어, 프레임워크, OS, DB 등"></textarea>
          </div>

          <div>
            <label for="prefer">우대사항</label>
            <textarea id="prefer" placeholder="우대 경력, 자격증, 도메인 경험 등"></textarea>
          </div>

          <div class="field-row">
            <div>
              <label for="period">투입기간</label>
              <input type="text" id="period" autocomplete="off" placeholder="예: 25.01 ~ 25.06" />
            </div>
            <div>
              <label for="startDate">투입예상일자</label>
              <input type="date" id="startDate" />
            </div>
          </div>

          <div>
            <label for="vendor">추천업체</label>
            <input type="text" id="vendor" autocomplete="off" placeholder="예: OO시스템, △△소프트 등" />
          </div>

          <div class="form-actions">
            <button type="button" class="main" id="btnPreview">값 확인</button>
            <button type="button" id="btnAdd">추가하기</button>
          </div>
          <div class="hint">
            ※ Enter(단독) 또는 [값 확인] → 아래 &lt;세부내용&gt;에서 미리보기,<br>
            단, <strong>업무, 필요기술</strong> 입력칸에서는 Enter로 줄바꿈 (미리보기 실행 안 됨)<br>
            Shift+Enter → 줄바꿈
          </div>
        </form>
      </section>

      <!-- 아래: 업무협조요청 - 견적 -->
      <section class="panel" id="right-panel">
        <h2 class="panel-title">업무협조요청 - 견적</h2>
        <div class="subtitle">한솔PNS IT부문</div>

        <div class="table-section">
          <h3>&lt;세부내용&gt;</h3>
          <div id="tableContainer">
            <!-- renderTable에서 채움 -->
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- 예시화면 모달 -->
  <div class="overlay" id="exampleOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2>예시화면</h2>
        <button class="modal-close" id="exampleClose" aria-label="닫기">×</button>
      </div>
      <div class="modal-note">
        실제 출력 형태 예시입니다. (내용은 샘플입니다)
      </div>
      <table>
        <thead>
          <tr>
            <th>순번</th>
            <th>프로젝트</th>
            <th>분야</th>
            <th>인원</th>
            <th>업무 / 필요 기술 / 개발 환경 / 우대사항</th>
            <th>투입기간</th>
            <th>상주</th>
            <th>투입예상일자</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>한솔 홈데코 SAP 업그레이드 프로젝트</td>
            <td>MES (중/고급)</td>
            <td>1</td>
            <td>
              ○ 주요 업무<br>
              ERP 튜닝(성능) 업무 화면 개선(설계서 기반)<br>
              Vue.js 및 AgGrid 기반 프론트엔드 화면 개발<br>
              Java Spring 기반 API 및 배치 모듈 개발<br>
              Oracle SQL 쿼리 및 성능 개선<br><br>
              ○ 필요 기술<br>
              웹 개발 경력 5년 이상(중급 이상개발자, 고급도 가능)<br>
              Java, Spring Framework 기반 백엔드 개발 역량 보유<br>
              Vue.js, JavaScript 기반 프론트엔드 개발 경험<br>
              Oracle SQL/PLSQL 활용 성능 최적화 경험<br>
              MyBatis 기반 DB 매퍼 개발 경험 등
            </td>
            <td>25/12/15 ~ 26/06/30<br>(6.50M/M)</td>
            <td>서울 신대방동</td>
            <td>9월 8~9일, 15~16일, 22~23일</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;

    const form = document.getElementById('inputForm');
    const tableContainer = document.getElementById('tableContainer');

    const btnPreview = document.getElementById('btnPreview');
    const btnAdd = document.getElementById('btnAdd');
    const btnPdf = document.getElementById('btnPdf');
    const btnExcel = document.getElementById('btnExcel');
    const btnCapture = document.getElementById('btnCapture');
    const btnExample = document.getElementById('btnExample');

    const exampleOverlay = document.getElementById('exampleOverlay');
    const exampleClose = document.getElementById('exampleClose');

    let entries = [];        // 확정된 목록
    let nextSeq = 1;         // 순번
    let previewData = null;  // 미리보기용 데이터

    function getFormData() {
      return {
        seq: nextSeq,
        project: document.getElementById('project').value.trim(),
        field: document.getElementById('field').value.trim(),
        people: document.getElementById('people').value.trim(),
        workSkill: document.getElementById('workSkill').value, // 줄 구조 유지
        env: document.getElementById('env').value.trim(),
        prefer: document.getElementById('prefer').value.trim(),
        period: document.getElementById('period').value.trim(),
        startDate: document.getElementById('startDate').value,
        onsite: document.getElementById('onsite').value.trim(),
        vendor: document.getElementById('vendor').value.trim()
      };
    }

    function formatDate(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return '';
      const parts = yyyy_mm_dd.split('-');
      if (parts.length !== 3) return yyyy_mm_dd;
      const [y, m, d] = parts;
      return `${y}.${m}.${d}`;
    }

    function renderTable() {
      // 4번/5번: 값 확인 안 눌러도 빈 칸(템플릿) 한 줄은 항상 보이게
      if (!entries.length && !previewData) {
        let html = '<table><thead><tr>';
        const headers = [
          '순번', '프로젝트', '분야', '인원',
          '업무,필요기술', '개발 환경', '우대사항',
          '투입기간', '투입예상일자', '상주여부(지역)', '추천업체'
        ];
        headers.forEach(h => {
          html += `<th>${h}</th>`;
        });
        html += '</tr></thead><tbody>';

        html += '<tr class="template-row">';
        for (let i = 0; i < headers.length; i++) {
          if (i === 0) html += '<td>1</td>'; // 순번 예시 1
          else html += '<td>&nbsp;</td>';
        }
        html += '</tr>';

        html += '</tbody></table>';
        tableContainer.innerHTML = html;
        return;
      }

      let html = '<table><thead><tr>';
      const headers = [
        '순번', '프로젝트', '분야', '인원',
        '업무,필요기술', '개발 환경', '우대사항',
        '투입기간', '투입예상일자', '상주여부(지역)', '추천업체'
      ];
      headers.forEach(h => {
        html += `<th>${h}</th>`;
      });
      html += '</tr></thead><tbody>';

      // 미리보기 행 먼저
      if (previewData) {
        const row = previewData;
        html += '<tr class="preview-row">';
        html += `<td>${row.seq}</td>`;
        html += `<td>${row.project || ''}</td>`;
        html += `<td>${row.field || ''}</td>`;
        html += `<td>${row.people || ''}</td>`;
        html += `<td>${(row.workSkill || '').replace(/\n/g, '<br>')}</td>`;
        html += `<td>${(row.env || '').replace(/\n/g, '<br>')}</td>`;
        html += `<td>${(row.prefer || '').replace(/\n/g, '<br>')}</td>`;
        html += `<td>${row.period || ''}</td>`;
        html += `<td>${formatDate(row.startDate) || ''}</td>`;
        html += `<td>${row.onsite || ''}</td>`;
        html += `<td>${row.vendor || ''}</td>`;
        html += '</tr>';
      }

      // 확정된 목록
      entries.forEach(row => {
        html += '<tr>';
        html += `<td>${row.seq}</td>`;
        html += `<td>${row.project || ''}</td>`;
        html += `<td>${row.field || ''}</td>`;
        html += `<td>${row.people || ''}</td>`;
        html += `<td>${(row.workSkill || '').replace(/\n/g, '<br>')}</td>`;
        html += `<td>${(row.env || '').replace(/\n/g, '<br>')}</td>`;
        html += `<td>${(row.prefer || '').replace(/\n/g, '<br>')}</td>`;
        html += `<td>${row.period || ''}</td>`;
        html += `<td>${formatDate(row.startDate) || ''}</td>`;
        html += `<td>${row.onsite || ''}</td>`;
        html += `<td>${row.vendor || ''}</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      tableContainer.innerHTML = html;
    }

    function clearForm() {
      document.getElementById('project').value = '';
      document.getElementById('field').value = '';
      document.getElementById('people').value = '';
      document.getElementById('workSkill').value = '과업 :\n업무상세 :\n필요기술 :';
      document.getElementById('env').value = '';
      document.getElementById('prefer').value = '';
      document.getElementById('period').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('onsite').value = '';
      document.getElementById('vendor').value = '';
      document.getElementById('project').focus();
    }

    function doPreview() {
      previewData = getFormData();
      renderTable();
    }

    btnPreview.addEventListener('click', () => {
      doPreview();
    });

    btnAdd.addEventListener('click', () => {
      const data = getFormData();
      entries.push({ ...data });
      nextSeq += 1;
      previewData = null;
      clearForm();
      renderTable();
    });

    // Enter → 미리보기 (단, 업무/필요기술 textarea는 줄바꿈만)
    form.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        if (e.target.tagName === 'TEXTAREA' && e.target.id === 'workSkill') {
          return; // 줄바꿈만
        }
        e.preventDefault();
        doPreview();
      }
    });

    // PDF 다운로드: 업무협조요청 - 견적(오른쪽 패널만)
    btnPdf.addEventListener('click', async () => {
      const target = document.getElementById('right-panel');
      const canvas = await html2canvas(target, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');

      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

      let position = 0;
      let heightLeft = imgHeight;

      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      pdf.save('업무협조요청_세부내용.pdf');
    });

    // Excel 다운로드
    btnExcel.addEventListener('click', () => {
      if (!entries.length) {
        alert('엑셀로 내보낼 데이터가 없습니다.');
        return;
      }

      const header = [
        '순번', '프로젝트', '분야', '인원',
        '업무,필요기술', '개발 환경', '우대사항',
        '투입기간', '투입예상일자', '상주여부(지역)', '추천업체'
      ];

      const dataRows = entries.map(row => [
        row.seq,
        row.project,
        row.field,
        row.people,
        row.workSkill,
        row.env,
        row.prefer,
        row.period,
        formatDate(row.startDate),
        row.onsite,
        row.vendor
      ]);

      const ws = XLSX.utils.aoa_to_sheet([header, ...dataRows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '세부내용');
      XLSX.writeFile(wb, '업무협조요청_세부내용.xlsx');
    });

    // 캡쳐: 업무협조요청 - 견적(오른쪽 패널만, 요청 9)
    btnCapture.addEventListener('click', async () => {
      const target = document.getElementById('right-panel');
      const canvas = await html2canvas(target, { scale: 2 });
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = '업무협조요청_견적_화면.png';
      link.click();
    });

    // 예시화면 모달 열기/닫기 (요청 8)
    btnExample.addEventListener('click', () => {
      exampleOverlay.classList.add('active');
    });

    exampleClose.addEventListener('click', () => {
      exampleOverlay.classList.remove('active');
    });

    exampleOverlay.addEventListener('click', (e) => {
      if (e.target === exampleOverlay) {
        exampleOverlay.classList.remove('active');
      }
    });

    // 초기 렌더: 템플릿 한 줄 보여주기
    renderTable();
  </script>
</body>
</html>
