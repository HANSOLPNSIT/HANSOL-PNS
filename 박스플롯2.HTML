<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì™¸ì£¼ìš©ì—­ ë°•ìŠ¤í”Œë¡¯ Â· ëŒ€ë¶„ë¥˜ ë“œë¡­ë‹¤ìš´ / ì„œë¹„ìŠ¤ë“±ê¸‰ Xì¶•</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --brand:#60a5fa; --border:#1f2937; }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;}
    header{padding:18px 24px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#0f172a 0%, #0b1222 100%);}
    h1{margin:0 0 6px;font-size:18px;}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:18px 24px;}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px;}
    select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1222;color:var(--ink);}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    #plot{height:66vh;}
    .hint{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4;}
    .badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:11px;background:#0b2546;color:#b9dcff;border:1px solid #1f3b66;}
    .def-table{width:100%;border-collapse:collapse;margin-top:8px;background:#0b1222;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .def-table th,.def-table td{padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px;text-align:left}
    .def-table thead th{background:#0d1526;color:var(--muted);font-weight:600;font-size:12px}
    .callout{margin-top:10px;font-size:13px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .btn{display:flex;align-items:center;justify-content:center;height:42px;padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1222;color:#e5e7eb;cursor:pointer;transition:.2s}
    .btn:hover{background:#1a253b;border-color:#4b5563}
  </style>
</head>
<body>
  <header>
    <h1>ì™¸ì£¼ìš©ì—­ ë°•ìŠ¤í”Œë¡¯</h1>
    <div class="hint">
      ì¡°ê±´(ë“œë¡­ë‹¤ìš´): <span class="badge">ëŒ€ë¶„ë¥˜ = "ë¶„ë¥˜"(P í—¤ë”)</span> Â· Xì¶•: <span class="badge">ì„œë¹„ìŠ¤ë“±ê¸‰ = "ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­"(U í—¤ë”)</span> Â· Yì¶•:
      <span class="badge">ì„œë¹„ìŠ¤ë‹¨ê°€ = "ì„œë¹„ìŠ¤ë‹¨ê°€"(Z í—¤ë”)</span> Â· ë²”ìœ„: <span class="badge">477â€“1000í–‰(ë¹„ì–´ìˆìœ¼ë©´ ë¬´ì‹œ)</span>
    </div>
  </header>

  <div class="wrap">
    <!-- ì¢Œì¸¡ ì„¤ì • -->
    <section class="card">
      <label>ëŒ€ë¶„ë¥˜(ë¶„ë¥˜) ì„ íƒ</label>
      <select id="category"></select>

      <label style="margin-top:14px;">ì˜µì…˜</label>
      <div class="row">
        <select id="orientation">
          <option value="v" selected>ìˆ˜ì§ ë°•ìŠ¤(ì„œë¹„ìŠ¤ë“±ê¸‰ = Xì¶•)</option>
          <option value="h">ìˆ˜í‰ ë°•ìŠ¤(ì„œë¹„ìŠ¤ë“±ê¸‰ = Yì¶•)</option>
        </select>
        <select id="outliers">
          <option value="none" selected>ì´ìƒì¹˜ ìˆ¨ê¹€</option>
          <option value="suspected">ì´ìƒì¹˜ í‘œì‹œ</option>
        </select>
      </div>

      <div class="hint" style="margin-top:10px;">
        â€» í—¤ë”ì˜ ê³µë°±/ëŒ€ì†Œë¬¸ìëŠ” ìë™ ë³´ì •í•©ë‹ˆë‹¤. ì˜ˆ: â€œì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­â€, â€œì„œë¹„ìŠ¤ë“±ê¸‰ë‚´ì—­â€, â€œì„œë¹„ìŠ¤ë“±ê¸‰â€.
      </div>
      <button id="loadDefault" class="btn" style="margin-top:12px;">DATA.xlsx ìë™ ë¡œë“œ</button>
    </section>

    <!-- ìš°ì¸¡ ì°¨íŠ¸ -->
    <section class="card">
      <div id="plot"></div>
    </section>
  </div>

  <!-- (ì„ íƒ) ì„¤ëª… ì„¹ì…˜ -->
  <div class="wrap" style="padding-top:0;">
    <section class="card" style="grid-column:1 / -1;">
      <h2 style="margin:0 0 10px;font-size:16px;">ğŸ“¦ ë°•ìŠ¤í”Œë¡¯(Box Plot) ì •ì˜</h2>
      <p class="callout">
        ë°•ìŠ¤í”Œë¡¯ì€ ë°ì´í„°ì˜ ë¶„í¬ë¥¼ <strong>ì‚¬ë¶„ìœ„ìˆ˜(Quartiles)</strong> ì¤‘ì‹¬ìœ¼ë¡œ ìš”ì•½í•´ ë³´ì—¬ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
        ì¤‘ì•™ê°’(Q2), <strong>IQR = Q3 âˆ’ Q1</strong>, <strong>ìˆ˜ì—¼(whisker)</strong>ì„ í†µí•´ ì¤‘ì‹¬Â·ì‚°í¬Â·ì´ìƒì¹˜ ì—¬ë¶€ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.
      </p>
      <table class="def-table">
        <thead><tr><th style="width:80px">êµ¬ë¶„</th><th style="width:160px">ì´ë¦„</th><th>ì˜ë¯¸</th><th style="width:180px">ê³„ì‚° ë°©ë²•</th></tr></thead>
        <tbody>
          <tr><td>Q1</td><td>ì œ1ì‚¬ë¶„ìœ„ìˆ˜</td><td>í•˜ìœ„ 25% ì§€ì </td><td>25ë²ˆì§¸ ë°±ë¶„ìœ„ìˆ˜</td></tr>
          <tr><td>Q2</td><td>ì¤‘ì•™ê°’</td><td>ì¤‘ê°„ê°’</td><td>50ë²ˆì§¸ ë°±ë¶„ìœ„ìˆ˜</td></tr>
          <tr><td>Q3</td><td>ì œ3ì‚¬ë¶„ìœ„ìˆ˜</td><td>ìƒìœ„ 25% ì§ì „</td><td>75ë²ˆì§¸ ë°±ë¶„ìœ„ìˆ˜</td></tr>
          <tr><td>IQR</td><td>ì‚¬ë¶„ìœ„ë²”ìœ„</td><td>ì¤‘ì•™ 50% ë²”ìœ„</td><td>Q3 âˆ’ Q1</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <script>
    // --- ê³ ì • Xì¶• ìˆœì„œ ---
    const GRADE_ORDER = ['ì´ˆê¸‰','ì¤‘ê¸‰','ê³ ê¸‰','íŠ¹ê¸‰','ì»¨ì„¤í„´íŠ¸'];

    // --- ì„¤ì • ìƒìˆ˜ ---
    const EXCEL_SHEET_NAME = "ì™¸ì£¼ìš©ì—­"; // ì‹œíŠ¸ëª…
    const ROW_START = 477; // í¬í•¨ (ì—‘ì…€ 1-based)
    const ROW_END   = 1000; // í¬í•¨ (ì—‘ì…€ 1-based)

    // í—¤ë”ëª… ë§¤ì¹­(ê³µë°±/ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
    const HEADER_MAP = {
      P: ['ë¶„ë¥˜'],
      U: ['ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­','ì„œë¹„ìŠ¤ë“±ê¸‰ë‚´ì—­','ì„œë¹„ìŠ¤ë“±ê¸‰'],
      Z: ['ì„œë¹„ìŠ¤ë‹¨ê°€']
    };

    const els = {
      loadDefault: document.getElementById('loadDefault'),
      category: document.getElementById('category'),
      orientation: document.getElementById('orientation'),
      outliers: document.getElementById('outliers'),
      plot: document.getElementById('plot'),
    };

    let state = {
      headers: [],
      rows: [],
      idx: { P:null, U:null, Z:null },
      categoryValues: [],
    };

    // ===== ë¡œë“œ ê³µí†µ =====
    async function loadWorkbookFromArrayBuffer(ab) {
      const wb = XLSX.read(ab, { type: 'array' });
      const sheetName = wb.Sheets[EXCEL_SHEET_NAME] ? EXCEL_SHEET_NAME : wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:null });
    }

    const norm = s => String(s ?? '').replace(/\s+/g,'').toLowerCase();
    function findHeaderIndex(headers, candidates){
      const hnorm = headers.map(norm);
      for (const name of candidates){
        const j = hnorm.indexOf(norm(name));
        if (j !== -1) return j;
      }
      return -1;
    }

    function showLoadError(tried) {
      const list = tried.map(u => `<li style="word-break:break-all">${u}</li>`).join('');
      els.plot.innerHTML =
        `<div style="padding:12px;color:#9ca3af;line-height:1.5">
           <div style="margin-bottom:6px">DATA.xlsx ìë™ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>
           <div style="margin-bottom:6px">ë‹¤ìŒ ê²½ë¡œë“¤ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤:</div>
           <ul style="margin:0 0 8px 16px;">${list}</ul>
           <div style="font-size:12px">
             ì ê²€: (1) íŒŒì¼ëª… ëŒ€/ì†Œë¬¸ì, (2) GitHub Pages ë¸Œëœì¹˜(main/master/gh-pages)ì— íŒŒì¼ ì¡´ì¬ ì—¬ë¶€,
             (3) ì €ì¥ì†Œê°€ Publicì¸ì§€, (4) í˜ì´ì§€ì™€ ë™ì¼ ê²½ë¡œ í´ë”ì— íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
           </div>
         </div>`;
    }

    // ===== ê¸°ë³¸ íŒŒì¼(DATA.xlsx ë“±) ìë™ ë¡œë“œ (GitHub raw í´ë°± ì§€ì›) =====
    async function tryLoadDefault() {
      const tried = [];

      // 1) ê°™ì€ í´ë” ìƒëŒ€ ê²½ë¡œ ìš°ì„  ì‹œë„
      const localNames = ['DATA.xlsx','DATA.XLSX','Data.xlsx','data.xlsx'];
      const basePath = location.origin + location.pathname.replace(/[^/]*$/, '');
      for (const name of localNames) {
        const url = name;
        tried.push(basePath + name);
        try {
          const res = await fetch(url, { cache:'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const ab = await res.arrayBuffer();
          const rows = await loadWorkbookFromArrayBuffer(ab);
          ingestRows(rows);
          return;
        } catch (e) { /* ê³„ì† ì‹œë„ */ }
      }

      // 2) GitHub Pagesì¼ ê²½ìš° raw ê²½ë¡œ í´ë°± (ë¸Œëœì¹˜/íŒŒì¼ëª…/ê²½ë¡œ ë³€í˜• ëª¨ë‘ ì‹œë„)
      if (location.hostname.endsWith('github.io')) {
        const user = location.hostname.split('.')[0];
        const parts = location.pathname.split('/').filter(Boolean); // [repo, ...subdirs..., maybe file]
        const repo = parts[0] || '';
        // repo ì´í•˜ ê²½ë¡œ(í˜ì´ì§€ê°€ /repo/sub/.. ë¼ë©´ sub/... ì „ì²´ ë³´ì¡´)
        const subPath = parts.slice(1).join('/'); // íŒŒì¼ì´ ìˆëŠ” í´ë” ê²½ë¡œë¡œ ê°€ì •
        const branches = ['main','master','gh-pages'];
        const filenames = ['DATA.xlsx','DATA.XLSX','Data.xlsx','data.xlsx'];

        for (const br of branches) {
          for (const fn of filenames) {
            const raw = `https://raw.githubusercontent.com/${user}/${repo}/${br}/${subPath ? subPath + '/' : ''}${fn}?ts=${Date.now()}`;
            tried.push(raw);
            try {
              const res = await fetch(raw, { cache:'no-store' });
              if (!res.ok) throw new Error('HTTP ' + res.status);
              const ab = await res.arrayBuffer();
              const rows = await loadWorkbookFromArrayBuffer(ab);
              ingestRows(rows);
              return;
            } catch (e) { /* ë‹¤ìŒ í›„ë³´ ê³„ì† */ }
          }
        }
      }
      showLoadError(tried);
    }

    // ===== ë°ì´í„° ì£¼ì…/ê·¸ë¦¬ê¸° =====
    function ingestRows(rows) {
      if (!rows?.length) {
        alert('ì‹œíŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      const first = rows[0] || [];
      const headerLike = first.some(v => typeof v === 'string' && String(v).trim() !== '');
      if (!headerLike) {
        alert('í—¤ë” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 1í–‰ì— "ë¶„ë¥˜ / ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­ / ì„œë¹„ìŠ¤ë‹¨ê°€" í—¤ë”ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      const headerRow = first;
      const data = rows.slice(1);

      // ë²”ìœ„ ìŠ¬ë¼ì´ì‹± (1-based í–‰ë²ˆí˜¸ ê¸°ì¤€ 477~1000) â†’ 0-based ì¸ë±ìŠ¤(í—¤ë” ì œì™¸)ë¡œ ë³€í™˜
      const startIdx = ROW_START - 2;
      const endIdx   = ROW_END   - 2;
      const slice = data.filter((_, i) => i >= startIdx && i <= endIdx);

      state.rows = slice;
      state.headers = headerRow.slice();

      // ë™ì  ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
      const pIdx = findHeaderIndex(state.headers, HEADER_MAP.P);
      const uIdx = findHeaderIndex(state.headers, HEADER_MAP.U);
      const zIdx = findHeaderIndex(state.headers, HEADER_MAP.Z);

      if (pIdx < 0 || uIdx < 0 || zIdx < 0) {
        alert(`í•„ìˆ˜ í—¤ë” ëˆ„ë½:\n- ë¶„ë¥˜: ${pIdx<0?'ì—†ìŒ':'OK'}\n- ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­: ${uIdx<0?'ì—†ìŒ':'OK'}\n- ì„œë¹„ìŠ¤ë‹¨ê°€: ${zIdx<0?'ì—†ìŒ':'OK'}`);
        return;
      }
      state.idx = { P:pIdx, U:uIdx, Z:zIdx };

      // ì¹´í…Œê³ ë¦¬(ë¶„ë¥˜) ëª©ë¡ êµ¬ì„±
      const pVals = slice.map(r => r[pIdx]).filter(v => v != null && String(v).trim() !== '');
      state.categoryValues = Array.from(new Set(pVals.map(v => String(v)))).sort((a,b)=>a.localeCompare(b,'ko'));

      populateCategorySelect();

      els.orientation.onchange = draw;
      els.outliers.onchange = draw;

      draw();
    }

    function populateCategorySelect(){
      els.category.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '__ALL__';
      optAll.textContent = `ì „ì²´ (${state.categoryValues.length}ê°œ ë¶„ë¥˜)`;
      els.category.appendChild(optAll);

      state.categoryValues.forEach(v=>{
        const o=document.createElement('option');
        o.value=String(v);
        o.textContent=String(v);
        els.category.appendChild(o);
      });
      els.category.value='__ALL__';
      els.category.onchange = draw;
    }

    function draw(){
      if (!state.rows.length){ Plotly.purge(els.plot); return; }
      const {P:COL_P_IDX, U:COL_U_IDX, Z:COL_Z_IDX} = state.idx;
      const catSel = els.category.value;
      const orient = els.orientation.value;
      const showOutliers = els.outliers.value !== 'none';

      const filtered = state.rows.filter(r=>{
        const p=r[COL_P_IDX], u=r[COL_U_IDX], y=r[COL_Z_IDX];
        if (p==null || String(p).trim()==='') return false;
        if (u==null || String(u).trim()==='') return false;
        if (y==null || y==='' || !isFinite(+y)) return false;
        return (catSel==='__ALL__') || String(p)===catSel;
      });

      // ë“±ê¸‰ë³„ ê·¸ë£¹í™”
      const byGrade = new Map();
      for (const r of filtered){
        const g=String(r[COL_U_IDX]).trim();
        const v=+r[COL_Z_IDX];
        if (!byGrade.has(g)) byGrade.set(g,[]);
        byGrade.get(g).push(v);
      }

      const traces=[];
      const metricName = state.headers[COL_Z_IDX] ?? 'ì„œë¹„ìŠ¤ë‹¨ê°€';

      for (const g of GRADE_ORDER){
        const arr=(byGrade.get(g)||[]).filter(Number.isFinite);
        if (arr.length){
          const hover = (orient==='v')
            ? `${g}<br>%{y:,.0f}ì›<extra></extra>`
            : `${g}<br>%{x:,.0f}ì›<extra></extra>`;
          const t = {
            type:'box', name:g, boxpoints: showOutliers?'suspectedoutliers':false,
            jitter:.3, pointpos:0, hovertemplate:hover
          };
          if (orient==='v') t.y=arr; else { t.x=arr; t.orientation='h'; }
          traces.push(t);
        }else{
          const ph={type:'box',name:g,boxpoints:false,hoverinfo:'skip',
            line:{color:'rgba(0,0,0,0)',width:0},fillcolor:'rgba(0,0,0,0)',marker:{color:'rgba(0,0,0,0)'}};
          if (orient==='v') ph.y=[0]; else { ph.x=[0]; ph.orientation='h'; }
          traces.push(ph);
        }
      }

      const numericAxis = {
        tickformat:',', ticksuffix:'ì›', gridcolor:'#1f2937', zerolinecolor:'#1f2937',
        automargin:true, title:{text:metricName, standoff:16}
      };
      const catAxis = {
        gridcolor:'#1f2937', zerolinecolor:'#1f2937', automargin:true,
        categoryorder:'array', categoryarray:GRADE_ORDER, tickmode:'array',
        tickvals:GRADE_ORDER, ticktext:GRADE_ORDER
      };

      const titleCat = (catSel==='__ALL__') ? 'ì „ì²´ ë¶„ë¥˜' : `ë¶„ë¥˜: ${catSel}`;
      const layout={
        paper_bgcolor:'#0f172a', plot_bgcolor:'#0f172a', font:{color:'#e5e7eb'},
        margin:{t:48,r:24,b:72,l:84}, showlegend:false,
        title:`${titleCat} Â· Yì¶•: ${metricName}`
      };
      if (orient==='v'){ layout.xaxis={title:'ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­',...catAxis}; layout.yaxis=numericAxis; }
      else { layout.xaxis=numericAxis; layout.yaxis={title:'ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­',...catAxis}; }

      Plotly.react(els.plot, traces, layout, {responsive:true, displaylogo:false});
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©/ìµœì´ˆ ë¡œë“œ
    els.loadDefault.addEventListener('click', tryLoadDefault);
    tryLoadDefault();
  </script>
</body>
</html>
