<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì™¸ì£¼ìš©ì—­ ë°•ìŠ¤í”Œë¡¯ Â· ë¶„ë¥˜ë³„ & ì—…ì²´ë³„ ë‚˜ë€íˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif}
    header{padding:18px 24px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#0f172a 0%, #0b1222 100%)}
    h1{margin:0 0 6px;font-size:18px}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:18px 24px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
    select,button{width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid #374151;background:#0b1222;color:var(--ink)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    #plot{height:70vh}
    .hint{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:11px;
      background:#0b2546;color:#b9dcff;border:1px solid #1f3b66}
    .btn{display:flex;align-items:center;justify-content:center;height:42px;
      padding:10px 12px;border-radius:12px;border:1px solid #374151;
      background:#0b1222;color:#e5e7eb;cursor:pointer;transition:.2s}
    .btn:hover{background:#1a253b;border-color:#4b5563}
  </style>
</head>
<body>
  <header>
    <h1>ì™¸ì£¼ìš©ì—­ ë°•ìŠ¤í”Œë¡¯</h1>
    <div class="hint">
      ì¡°ê±´(í–‰ ì´ë¦„ ìë™ë§¤í•‘): ëŒ€ë¶„ë¥˜=â€˜ë¶„ë¥˜â€™ ì…€ Â· Xì¶•=â€˜ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­â€™ ì…€ Â· Yì¶•=â€˜ì„œë¹„ìŠ¤ë‹¨ê°€â€™
      <span class="badge">ì„œë¹„ìŠ¤ë‹¨ê°€</span> Â· ë²”ìœ„: <span class="badge">477â€“1000í–‰(ë¹„ì–´ìˆìœ¼ë©´ ë¬´ì‹œ)</span>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <label>ëŒ€ë¶„ë¥˜(ë¶„ë¥˜ Â· Pì—´) ì„ íƒ</label>
      <select id="category"></select>

      <label style="margin-top:14px;">ì—…ì²´(êµ¬ë§¤ì²˜ëª…) ì„ íƒ</label>
      <select id="vendor"></select>

      <label style="margin-top:14px;">ì˜µì…˜</label>
      <div class="row">
        <select id="orientation">
          <option value="v" selected>ìˆ˜ì§ ë°•ìŠ¤(ì„œë¹„ìŠ¤ë“±ê¸‰ = Xì¶•)</option>
          <option value="h">ìˆ˜í‰ ë°•ìŠ¤(ì„œë¹„ìŠ¤ë“±ê¸‰ = Yì¶•)</option>
        </select>
        <select id="outliers">
          <option value="none" selected>ì´ìƒì¹˜ ìˆ¨ê¹€</option>
          <option value="suspected">ì´ìƒì¹˜ í‘œì‹œ</option>
        </select>
      </div>

      <div class="hint" style="margin-top:10px;">
        â€» í—¤ë”ê°€ ìˆì„ ê²½ìš°, <code>ë¶„ë¥˜(P)</code> / <code>ì„œë¹„ìŠ¤ ë“±ê¸‰ë‚´ì—­(U)</code> / <code>ì„œë¹„ìŠ¤ë‹¨ê°€(Z)</code> / <code>êµ¬ë§¤ì²˜ëª…</code> ì„ ìë™ ë§¤í•‘í•©ë‹ˆë‹¤.
      </div>
      <button id="loadDefault" class="btn" style="margin-top:12px;">ê¸°ë³¸ íŒŒì¼(data.xlsx) ìë™ ë¡œë“œ</button>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px;font-size:16px;">ğŸ“Š ë¶„ë¥˜ë³„ vs ì—…ì²´ë³„ ë°•ìŠ¤í”Œë¡¯</h2>
      <div id="plot"></div>
    </section>
  </div>

  <script>
    const GRADE_ORDER = ['ì´ˆê¸‰','ì¤‘ê¸‰','ê³ ê¸‰','íŠ¹ê¸‰','ì»¨ì„¤í„´íŠ¸'];
    const EXCEL_SHEET_NAME = "ì™¸ì£¼ìš©ì—­";
    const ROW_START = 477, ROW_END = 1000;
    let COL_P_IDX = 15, COL_U_IDX = 20, COL_Z_IDX = 25, COL_VENDOR_IDX = -1;

    const els = {
      loadDefault: document.getElementById('loadDefault'),
      category: document.getElementById('category'),
      vendor: document.getElementById('vendor'),
      orientation: document.getElementById('orientation'),
      outliers: document.getElementById('outliers'),
      plot: document.getElementById('plot'),
    };

    let state = { headers: [], rows: [], categoryValues: [], vendorValues: [] };

    async function loadWorkbookFromArrayBuffer(ab) {
      const wb = XLSX.read(ab, { type: 'array' });
      const ws = wb.Sheets[EXCEL_SHEET_NAME] || wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:null });
    }

    async function tryLoadDefault() {
      try {
        const res = await fetch('data.xlsx', { cache:'no-store' });
        if (!res.ok) throw new Error();
        const ab = await res.arrayBuffer();
        const rows = await loadWorkbookFromArrayBuffer(ab);
        ingestRows(rows);
      } catch {
        els.plot.innerHTML = '<div style="padding:12px;color:#9ca3af;">data.xlsx ìë™ ë¡œë“œ ì‹¤íŒ¨</div>';
      }
    }

    function normHeader(v){ return String(v ?? '').trim().replaceAll(/\s+/g,'').toLowerCase(); }

    function autoMapColumns(headerRow){
      const hnorm = headerRow.map(normHeader);
      const idxP = hnorm.indexOf('ë¶„ë¥˜'); if (idxP!=-1) COL_P_IDX=idxP;
      const idxU = hnorm.findIndex(h=>['ì„œë¹„ìŠ¤ë“±ê¸‰ë‚´ì—­','ì„œë¹„ìŠ¤ë“±ê¸‰','ë“±ê¸‰'].includes(h)); if (idxU!=-1) COL_U_IDX=idxU;
      const idxZ = hnorm.indexOf('ì„œë¹„ìŠ¤ë‹¨ê°€'); if (idxZ!=-1) COL_Z_IDX=idxZ;
      const idxVendor = hnorm.findIndex(h=>['êµ¬ë§¤ì²˜ëª…','êµ¬ë§¤ì²˜','ê³µê¸‰ì—…ì²´','ì—…ì²´ëª…','ê±°ë˜ì²˜ëª…','ê³µê¸‰ì²˜'].includes(h));
      if (idxVendor!=-1) COL_VENDOR_IDX=idxVendor;
    }

    function ingestRows(rows) {
      const headerRow = rows[0];
      autoMapColumns(headerRow);
      const data = rows.slice(1).filter((_,i)=>i+1>=ROW_START && i+1<=ROW_END);
      state.rows = data;
      const pVals = data.map(r=>r[COL_P_IDX]).filter(v=>v);
      state.categoryValues = [...new Set(pVals.map(String))].sort((a,b)=>a.localeCompare(b,'ko'));
      const vVals = COL_VENDOR_IDX>=0 ? data.map(r=>r[COL_VENDOR_IDX]).filter(v=>v) : [];
      state.vendorValues = [...new Set(vVals.map(String))].sort((a,b)=>a.localeCompare(b,'ko'));
      populateSelects();
      drawCombined();
    }

    function populateSelects(){
      els.category.innerHTML = `<option value="__ALL__">ì „ì²´ (${state.categoryValues.length}ê°œ)</option>` +
        state.categoryValues.map(v=>`<option>${v}</option>`).join('');
      els.vendor.innerHTML = `<option value="__ALL__">ì „ì²´ (${state.vendorValues.length}ê°œ)</option>` +
        state.vendorValues.map(v=>`<option>${v}</option>`).join('');
      els.category.onchange = els.vendor.onchange = els.orientation.onchange = els.outliers.onchange = drawCombined;
    }

    function drawCombined(){
      if (!state.rows.length) return;
      const catSel = els.category.value, vendorSel = els.vendor.value;
      const orient = els.orientation.value;
      const showOutliers = els.outliers.value!=='none';

      const filterRows = (fn)=>state.rows.filter(fn);
      const rowsCat = filterRows(r=>{
        const p=r[COL_P_IDX], u=r[COL_U_IDX], y=r[COL_Z_IDX];
        return u && y && isFinite(y) && (catSel==='__ALL__' || String(p)===catSel);
      });
      const rowsVendor = filterRows(r=>{
        const v=r[COL_VENDOR_IDX], u=r[COL_U_IDX], y=r[COL_Z_IDX];
        return v && u && y && isFinite(y) && (vendorSel==='__ALL__' || String(v)===vendorSel);
      });

      const groupBy = (rows)=>{const m=new Map();for(const r of rows){const g=r[COL_U_IDX];const val=+r[COL_Z_IDX];if(!m.has(g))m.set(g,[]);m.get(g).push(val);}return m;};
      const gCat = groupBy(rowsCat), gVendor = groupBy(rowsVendor);
      const traces=[];
      for(const g of GRADE_ORDER){
        const a=gCat.get(g)||[], b=gVendor.get(g)||[];
        if(a.length){
          const tA={type:'box',name:`ë¶„ë¥˜:${catSel==='__ALL__'?'ì „ì²´':catSel}`,x:[g],boxpoints:showOutliers?'suspectedoutliers':false,
            fillcolor:'rgba(96,165,250,0.4)',line:{color:'#60a5fa',width:1.5},marker:{color:'#60a5fa'},jitter:.3,pointpos:0};
          if(orient==='v')tA.y=a; else{tA.x=a;tA.orientation='h';tA.y=[g];}
          traces.push(tA);
        }
        if(b.length){
          const tB={type:'box',name:`ì—…ì²´:${vendorSel==='__ALL__'?'ì „ì²´':vendorSel}`,x:[g],boxpoints:showOutliers?'suspectedoutliers':false,
            fillcolor:'rgba(239,68,68,0.4)',line:{color:'#ef4444',width:1.5},marker:{color:'#ef4444'},jitter:.3,pointpos:0};
          if(orient==='v')tB.y=b; else{tB.x=b;tB.orientation='h';tB.y=[g];}
          traces.push(tB);
        }
      }

      const layout={
        paper_bgcolor:'#0f172a',plot_bgcolor:'#0f172a',font:{color:'#e5e7eb'},
        boxmode:'group',showlegend:true,margin:{t:48,r:24,b:72,l:84},
        xaxis:{categoryorder:'array',categoryarray:GRADE_ORDER,title:'ì„œë¹„ìŠ¤ë“±ê¸‰'},
        yaxis:{tickformat:',',ticksuffix:'ì›',title:'ì„œë¹„ìŠ¤ë‹¨ê°€',gridcolor:'#1f2937'}
      };
      Plotly.react(els.plot,traces,layout,{responsive:true,displaylogo:false});
    }

    els.loadDefault.addEventListener('click',tryLoadDefault);
    tryLoadDefault();
  </script>
</body>
</html>
